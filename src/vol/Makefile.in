# Copyright 2000, International Business Machines Corporation and others.
# All Rights Reserved.
# 
# This software has been released under the terms of the IBM Public
# License.  For details, see the LICENSE file in the top-level source
# directory or online at http://www.openafs.org/dl/license10.html

DESTDIR=@DESTDIR@
SRCDIR=@SRCDIR@
TOP_SRCDIR=@TOP_SRCDIR@
SYS_NAME=@AFS_SYSNAME@

SHELL=/bin/sh

include ../config/Makefile.${SYS_NAME}

INCDIRS= -I${TOP_SRCDIR}/config -I. -I${DESTDIR}/include ${FSINCLUDES}
LDFLAGS = ${OPTMZ} ${PROF} ${LDIRS} ${XLDFLAGS}

LIBS= ${DESTDIR}/lib/afs/libcmd.a vlib.a ${SRCDIR}/lib/afs/util.a \
	${DESTDIR}/lib/afs/libsys.a ${DESTDIR}/lib/afs/libdir.a \
	${DESTDIR}/lib/liblwp.a  ${DESTDIR}/lib/afs/libacl.a ${XLIBS}

CFLAGS = -D${SYS_NAME} ${OPTMZ} ${INCDIRS} ${XCFLAGS} ${DBG}

PUBLICHEADERS=nfs.h vnode.h viceinode.h volume.h voldefs.h partition.h\
	fssync.h ihandle.h namei_ops.h

VLIBOBJS=vnode.o volume.o vutil.o partition.o fssync.o purge.o \
	 clone.o nuke.o devname.o listinodes.o common.o ihandle.o \
	 namei_ops.o

OBJECTS=${VLIBOBJS} physio.o vol-salvage.o vol-info.o 

all: install

#
# Installation targets
#
install: gi \
	${DESTDIR}/lib/afs/vlib.a \
	${DESTDIR}/lib/afs/libvlib.a \
	${DESTDIR}/root.server/usr/afs/bin/salvager \
	${DESTDIR}/root.server/usr/afs/bin/volinfo \
	$(FS_CONV_OSF40D) \
	$(XFS_SIZE_CHECK) \
	$(FS_CONV_SOL26) \
	${DESTDIR}/include/afs/nfs.h \
	${DESTDIR}/include/afs/vnode.h \
	${DESTDIR}/include/afs/viceinode.h \
	${DESTDIR}/include/afs/volume.h \
	${DESTDIR}/include/afs/voldefs.h \
	${DESTDIR}/include/afs/partition.h \
	${DESTDIR}/include/afs/fssync.h \
	${DESTDIR}/include/afs/ihandle.h \
	${DESTDIR}/include/afs/namei_ops.h

${DESTDIR}/root.server/usr/afs/bin/salvager: salvager 
	${INSTALL} -s $? $@

${DESTDIR}/root.server/usr/afs/bin/volinfo: volinfo
	${INSTALL} -s $? $@

${DESTDIR}/lib/afs/vlib.a: vlib.a
	${INSTALL} $? $@

${DESTDIR}/lib/afs/libvlib.a: vlib.a
	${INSTALL} $? $@

$(DESTDIR)root.server/usr/afs/bin/fs_conv_dux40D:  fs_conv_dux40D
	${INSTALL} -s $? $@

$(DESTDIR)root.server/usr/afs/bin/xfs_size_check:  xfs_size_check
	${INSTALL} -s $? $@

$(DESTDIR)root.server/usr/afs/bin/fs_conv_sol26:  fs_conv_sol26
	${INSTALL} -s $? $@

${DESTDIR}/include/afs/nfs.h: nfs.h
	${INSTALL} $? $@

${DESTDIR}/include/afs/vnode.h: vnode.h
	${INSTALL} $? $@

${DESTDIR}/include/afs/viceinode.h: viceinode.h
	${INSTALL} $? $@

${DESTDIR}/include/afs/volume.h: volume.h
	${INSTALL} $? $@

${DESTDIR}/include/afs/voldefs.h: voldefs.h
	${INSTALL} $? $@

${DESTDIR}/include/afs/partition.h: partition.h
	${INSTALL} $? $@

${DESTDIR}/include/afs/fssync.h: fssync.h
	${INSTALL} $? $@

${DESTDIR}/include/afs/ihandle.h: ihandle.h
	${INSTALL} $? $@

${DESTDIR}/include/afs/namei_ops.h: namei_ops.h
	${INSTALL} $? $@

#
# Build targets
#
${OBJECTS}: ${PUBLICHEADERS} ${SRCDIR}/include/lwp.h ${SRCDIR}/include/lock.h \
	 ${SRCDIR}/include/afs/afsint.h vutils.h salvage.h\
	AFS_component_version_number.c

vol-salvage.o vutil.o: volinodes.h

vlib.a:	${VLIBOBJS} AFS_component_version_number.o
	$(RM) -f $@
	$(AR) crv $@ ${VLIBOBJS} AFS_component_version_number.o
	$(RANLIB) $@

# new salvager:  remove references to /vice by linking with novice.o
salvager: vol-salvage.o physio.o vlib.a
	${CC} ${LDFLAGS} -o salvager vol-salvage.o physio.o ${LIBS}

vol-salvage: vol-salvage.o
vol-info: vol-info.o physio.o ihandle.o

listinodes.o: listinodes.c AFS_component_version_number.c
	case ${SYS_NAME} in				\
		hp?00_ux101 | hp_ux10? )		\
			${CC} ${CFLAGS} -D_FILE64 -c listinodes.c \
				;;			\
		* )	${CC} ${CFLAGS} -c listinodes.c \
				;;			\
	esac

gi: ${DESTDIR}/lib/afs/libsys.a
	case ${SYS_NAME} in \
                *linux* | sgi_* | *fbsd* ) \
			echo "Don't build gi on ${SYS_NAME}";; \
                *) \
			${CC} ${CFLAGS} -c gi.c ; \
			${CC} ${LDFLAGS} -o gi gi.o ${DESTDIR}/lib/afs/libsys.a;; \
        esac

volinfo: vol-info.o physio.o ihandle.o
	case ${SYS_NAME} in \
		*linux* | *fbsd*) \
			${CC} ${CFLAGS} ${DBG} -o volinfo vol-info.o physio.o \
				ihandle.o ${LIBS} ;; \
		*) \
			${CC} ${CFLAGS} ${DBG} -o volinfo vol-info.o physio.o \
				 ihandle.o ${LIBS} ;; \
	esac


fs_conv_dux40D: fs_conv_411.o
	${CC} ${CFLAGS} ${DESTDIR}/lib/afs/libcmd.a -o fs_conv_dux40D fs_conv_411.o  ${LIBS} 

fs_conv_sol26: fs_conv_411.o vlib.a 
	${CC} ${CFLAGS} ${DESTDIR}/lib/afs/libcmd.a -o fs_conv_sol26 fs_conv_411.o  ${LIBS} 

fs_conv_411.o: fs_conv_411.c AFS_component_version_number.c
	${CC} ${CFLAGS} -c fs_conv_411.c

xfs_size_check: xfs_size_check.c
	${CC} ${CFLAGS} -o xfs_size_check xfs_size_check.c

#
# Misc. targets
#
clean:
	$(RM) -f *.o *.a AFS_component_version_number.c
	$(RM) -f ${SCMPROGS} ${STAGEPROGS} core salvager volinfo gi fs_conv_sol26 fs_conv_dux40D

test:
	cd test; $(MAKE)

include ../config/Makefile.version
