# Copyright 2000, International Business Machines Corporation and others.
# All Rights Reserved.
# 
# This software has been released under the terms of the IBM Public
# License.  For details, see the LICENSE file in the top-level source
# directory or online at http://www.openafs.org/dl/license10.html

DESTDIR=@DESTDIR@
SRCDIR=@SRCDIR@
TOP_SRCDIR=@TOP_SRCDIR@
SYS_NAME=@AFS_SYSNAME@

SHELL = /bin/sh

include ../config/Makefile.${SYS_NAME}

KERNELDIR = ../libafs/
UKERNELDIR = ../libuafs/
COMPILE_ET = ${SRCDIR}/bin/compile_et
OBJS= cellconfig.o ktc.o userok.o writeconfig.o authcon.o \
    acfg_errors.o ktc_errors.o
KOBJS= cellconfig.o ktc.krb.o userok.o writeconfig.o authcon.o \
    acfg_errors.o ktc_errors.o

CFLAGS=-g -I${TOP_SRCDIR}/config -I${SRCDIR}/include ${XCFLAGS} 
LIBS= libauth.a ${DESTDIR}/lib/afs/libsys.a \
      ${DESTDIR}/lib/librxkad.a ${DESTDIR}/lib/libdes.a \
      ${DESTDIR}/lib/librx.a ${DESTDIR}/lib/afs/libsys.a \
      ${DESTDIR}/lib/liblwp.a ${SRCDIR}/lib/afs/util.a ${XLIBS}
INCLS=cellconfig.h auth.h keys.h
KSRCS=auth.h
UKSRCS=${KSRCS} cellconfig.h acfg_errors.c keys.h cellconfig.c \
       ktc.c authcon.c ktc_errors.c

all: install

cellconfig.o: cellconfig.c ${INCLS}
ktc.o: ktc.c ${INCLS} ${SRCDIR}/include/afs/vice.h
writeconfig.o: writeconfig.c ${INCLS}
authcon.o: authcon.c ${INCLS}
userok.o: userok.c ${INCLS}
cellconfig.o: cellconfig.c ${INCLS}
copyauth.o: copyauth.c ${INCLS} AFS_component_version_number.o
setkey.o: setkey.c ${INCLS} AFS_component_version_number.o

ktc.krb.o: ktc.c ${INCLS} ${SRCDIR}/include/afs/vice.h
	${CC} ${CFLAGS} -DAFS_KERBEROS_ENV -c ktc.c -o ktc.krb.o

libauth.a: $(OBJS) AFS_component_version_number.o
	-rm -f libauth.a
	ar rv libauth.a $(OBJS) AFS_component_version_number.o
	$(RANLIB) libauth.a

libauth.krb.a: $(KOBJS) AFS_component_version_number.o
	-rm -f libauth.krb.a
	ar rv libauth.krb.a $(KOBJS) AFS_component_version_number.o
	$(RANLIB) libauth.krb.a

copyauth: copyauth.o
	$(CC) $(CFLAGS) -o copyauth copyauth.o ${LIBS}

setkey: setkey.o
	${CC} $(CFLAGS) -o setkey setkey.o ${LIBS}

acfg_errors.o: acfg_errors.c

acfg_errors.c cellconfig.h: acfg_errors.et cellconfig.p.h
	rm -f cellconfig.h acfg_errors.c; ${COMPILE_ET} acfg_errors -h cellconfig

ktc_errors.o: ktc_errors.c

ktc_errors.c auth.h: ktc_errors.et auth.p.h
	rm -f auth.h ktc_errors.c; ${COMPILE_ET} ktc_errors -h auth

#
# Install targets
#
kinstall: ${KERNELDIR}/afs/auth.h

${KERNELDIR}/afs/auth.h: auth.h
	${INSTALL} $? $@

ukinstall: \
	${UKERNELDIR}/afs/auth.h \
	${UKERNELDIR}/afs/cellconfig.h \
	${UKERNELDIR}/afs/acfg_errors.c \
	${UKERNELDIR}/afs/keys.h \
	${UKERNELDIR}/afs/cellconfig.c \
	${UKERNELDIR}/afs/ktc.c \
	${UKERNELDIR}/afs/authcon.c \
	${UKERNELDIR}/afs/ktc_errors.c

${UKERNELDIR}/afs/auth.h: auth.h
	${INSTALL} $? $@

${UKERNELDIR}/afs/cellconfig.h: cellconfig.h
	${INSTALL} $? $@

${UKERNELDIR}/afs/cellconfig.c: cellconfig.c
	${INSTALL} $? $@

${UKERNELDIR}/afs/acfg_errors.c: acfg_errors.c
	${INSTALL} $? $@

${UKERNELDIR}/afs/keys.h: keys.h
	${INSTALL} $? $@

${UKERNELDIR}/afs/ktc.c: ktc.c
	${INSTALL} $? $@

${UKERNELDIR}/afs/authcon.c: authcon.c
	${INSTALL} $? $@

${UKERNELDIR}/afs/ktc_errors.c: ktc_errors.c
	${INSTALL} $? $@

install: kinstall ukinstall \
	${DESTDIR}/lib/afs/libauth.a \
	${DESTDIR}/lib/afs/libauth.krb.a \
	${DESTDIR}/include/afs/keys.h \
	${DESTDIR}/include/afs/cellconfig.h \
	${DESTDIR}/include/afs/auth.h \
	${DESTDIR}/etc/copyauth \
	setkey

${DESTDIR}/lib/afs/libauth.a: libauth.a
	${INSTALL} $? $@

${DESTDIR}/lib/afs/libauth.krb.a: libauth.krb.a
	${INSTALL} $? $@

${DESTDIR}/etc/copyauth: copyauth
	${INSTALL} $? $@

${DESTDIR}/include/afs/keys.h: keys.h
	${INSTALL} $? $@

${DESTDIR}/include/afs/cellconfig.h: cellconfig.h
	${INSTALL} $? $@

${DESTDIR}/include/afs/auth.h: auth.h
	${INSTALL} $? $@

#
# Misc. targets
#
test: 
	cd test; $(MAKE)

clean:
	rm -f *.o *.a copyauth setkey auth.h cellconfig.h acfg_errors.c ktc_errors.c core\
	AFS_component_version_number.c

include ../config/Makefile.version
